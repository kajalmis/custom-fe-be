name: Backend CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Build Docker image
      run: |
        cd backend
        docker build -t backend-1 .
    - name: Login to Amazon ECR
      run: |
        echo "${{ secrets.AWS_ACCESS_KEY_ID }}" >> aws_access_key_id
        echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> aws_secret_access_key
        aws configure set aws_access_key_id "$(cat aws_access_key_id)"
        aws configure set aws_secret_access_key "$(cat aws_secret_access_key)"
        aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 332931378908.dkr.ecr.us-east-1.amazonaws.com
      
    
      
    - name: Tag Docker image
      run: docker tag backend-1:latest 332931378908.dkr.ecr.us-east-1.amazonaws.com/kajal-mishra-niraj:latest
      
    - name: Push Docker image to Amazon ECR
      run: docker push 332931378908.dkr.ecr.us-east-1.amazonaws.com/kajal-mishra-niraj:latest
      
    - name: Update ECS Service
      run: aws ecs update-service --cluster KAJAL-ECS-CLUSTER --service KAJAL-ECS-SERVICE --force-new-deployment --region us-east-1
